{"version":3,"sources":["../../src/message/message.ts"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["import { SuperComponent, wxComponent, ComponentsOptionsType } from '../common/src/index';\nimport config from '../common/config';\nimport { MessageProps } from './message.interface';\nimport props from './props';\nimport { getRect, unitConvert, calcIcon } from '../common/utils';\n\nconst { prefix } = config;\nconst name = `${prefix}-message`;\n\n// 展示动画持续时间\nconst SHOW_DURATION = 500;\n@wxComponent()\nexport default class Message extends SuperComponent {\n  externalClasses = [\n    `${prefix}-class`,\n    `${prefix}-class-content`,\n    `${prefix}-class-icon`,\n    `${prefix}-class-action`,\n    `${prefix}-class-close-btn`,\n  ];\n\n  options: ComponentsOptionsType = {\n    styleIsolation: 'apply-shared',\n    multipleSlots: true,\n  };\n\n  // 组件的对外属性\n  properties: MessageProps = { ...props } as unknown as MessageProps;\n\n  // 组件的内部数据\n  data = {\n    prefix,\n    classPrefix: name,\n    loop: -1,\n    animation: [],\n    showAnimation: [],\n    wrapTop: -999, // 初始定位，保证在可视区域外。\n  };\n\n  observers = {\n    marquee(val) {\n      if (JSON.stringify(val) === '{}') {\n        this.setData({\n          marquee: {\n            speed: 50,\n            loop: -1,\n            delay: 5000,\n          },\n        });\n      }\n    },\n\n    icon(v) {\n      this.setData({\n        _icon: calcIcon(v, 'error-circle-filled'),\n      });\n    },\n\n    closeBtn(v) {\n      this.setData({\n        _closeBtn: calcIcon(v, 'close'),\n      });\n    },\n  };\n\n  /** 延时关闭句柄 */\n  closeTimeoutContext = 0;\n\n  /** 动画句柄 */\n  nextAnimationContext = 0;\n\n  resetAnimation = wx.createAnimation({\n    duration: 0,\n    timingFunction: 'linear',\n  });\n\n  ready() {\n    this.memoInitalData();\n  }\n\n  /** 记录组件设置的项目 */\n  memoInitalData() {\n    this.initalData = {\n      ...this.properties,\n      ...this.data,\n    };\n  }\n\n  resetData(cb: () => void) {\n    this.setData({ ...this.initalData }, cb);\n  }\n\n  detached() {\n    this.clearMessageAnimation();\n  }\n\n  /** 检查是否需要开启一个新的动画循环 */\n  checkAnimation() {\n    if (!this.properties.marquee) {\n      return;\n    }\n\n    const speeding = this.properties.marquee.speed;\n\n    if (this.data.loop > 0) {\n      this.data.loop -= 1;\n    } else if (this.data.loop === 0) {\n      // 动画回到初始位置\n      this.setData({ animation: this.resetAnimation.translateX(0).step().export() });\n      return;\n    }\n\n    if (this.nextAnimationContext) {\n      this.clearMessageAnimation();\n    }\n\n    const warpID = `#${name}__text-wrap`;\n    const nodeID = `#${name}__text`;\n    Promise.all([getRect(this, nodeID), getRect(this, warpID)]).then(([nodeRect, wrapRect]) => {\n      this.setData(\n        {\n          animation: this.resetAnimation.translateX(wrapRect.width).step().export(),\n        },\n        () => {\n          const durationTime = ((nodeRect.width + wrapRect.width) / speeding) * 1000;\n          const nextAnimation = wx\n            .createAnimation({\n              // 默认50px/s\n              duration: durationTime,\n            })\n            .translateX(-nodeRect.width)\n            .step()\n            .export();\n\n          // 这里就只能用 setTimeout/20, nextTick 没用\n          // 不用这个的话会出现reset动画没跑完就开始跑这个等的奇怪问题\n          setTimeout(() => {\n            this.nextAnimationContext = setTimeout(this.checkAnimation.bind(this), durationTime) as unknown as number;\n\n            this.setData({ animation: nextAnimation });\n          }, 20);\n        },\n      );\n    });\n  }\n\n  /** 清理动画循环 */\n  clearMessageAnimation() {\n    clearTimeout(this.nextAnimationContext);\n    this.nextAnimationContext = 0;\n  }\n\n  show() {\n    const { duration, marquee, offset } = this.properties;\n    this.setData({ visible: true, loop: marquee.loop });\n    this.reset();\n    this.checkAnimation();\n    if (duration && duration > 0) {\n      this.closeTimeoutContext = setTimeout(() => {\n        this.hide();\n        this.triggerEvent('durationEnd', { self: this });\n      }, duration) as unknown as number;\n    }\n\n    const wrapID = `#${name}`;\n    getRect(this, wrapID).then((wrapRect) => {\n      // 入场动画。先根据 message 的实际高度设置绝对定位的 top 值，再开始显示动画\n      this.setData({ wrapTop: -wrapRect.height }, () => {\n        this.setData({\n          showAnimation: wx\n            .createAnimation({ duration: SHOW_DURATION, timingFunction: 'ease' })\n            .translateY(wrapRect.height + unitConvert(offset[0]))\n            .step()\n            .export(),\n        });\n      });\n    });\n  }\n\n  hide() {\n    this.reset();\n    this.setData({\n      // 出场动画\n      showAnimation: wx\n        .createAnimation({ duration: SHOW_DURATION, timingFunction: 'ease' })\n        .translateY(this.data.wrapTop)\n        .step()\n        .export(),\n    });\n    setTimeout(() => {\n      this.setData({ visible: false, animation: [] });\n    }, SHOW_DURATION);\n  }\n\n  // 重置定时器\n  reset() {\n    if (this.nextAnimationContext) {\n      this.clearMessageAnimation();\n    }\n    clearTimeout(this.closeTimeoutContext);\n    this.closeTimeoutContext = 0;\n  }\n\n  handleClose() {\n    this.hide();\n    this.triggerEvent('closeBtnClick');\n  }\n\n  handleBtnClick() {\n    this.triggerEvent('actionBtnClick', { self: this });\n  }\n}\n"]}