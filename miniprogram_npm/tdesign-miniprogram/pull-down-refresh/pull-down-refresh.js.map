{"version":3,"sources":["../../src/pull-down-refresh/pull-down-refresh.ts"],"names":[],"mappings":"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","file":"pull-down-refresh.js","sourcesContent":["import { SuperComponent, wxComponent, RelationsOptions } from '../common/src/index';\nimport config from '../common/config';\nimport props from './props';\n\nconst { prefix } = config;\nconst name = `${prefix}-pull-down-refresh`;\n\n@wxComponent()\nexport default class PullDownRefresh extends SuperComponent {\n  pixelRatio = 1; // 像素比(rpx与px在此设备上的比值)\n\n  startPoint: { pageX: number; pageY: number } | null = null; // 下拉开始的起点，主要用于计算下拉高度\n\n  isPulling = false; // 是否下拉中\n\n  maxBarHeight: number = 0; // 最大下拉高度，单位 rpx\n\n  // 触发刷新的下拉高度，单位rpx\n  // 松开时下拉高度大于这个值即会触发刷新，触发刷新后松开，会恢复到这个高度并保持，直到刷新结束\n  loadingBarHeight = 200;\n\n  /** 开始刷新 - 刷新成功/失败 最大间隔时间setTimeout句柄 */\n  maxRefreshAnimateTimeFlag = 0;\n\n  /** 关闭动画耗时setTimeout句柄 */\n  closingAnimateTimeFlag = 0;\n\n  externalClasses = [`${prefix}-class`, `${prefix}-class-loading`, `${prefix}-class-tex`, `${prefix}-class-indicator`];\n\n  options = {\n    multipleSlots: true,\n  };\n\n  relations: RelationsOptions = {\n    '../back-top/back-top': {\n      type: 'descendant',\n    },\n  };\n\n  properties = props;\n\n  data = {\n    prefix,\n    classPrefix: name,\n    barHeight: 0,\n    refreshStatus: -1,\n    loosing: false,\n    enableToRefresh: true,\n    scrollTop: 0,\n  };\n\n  lifetimes = {\n    attached() {\n      const { screenWidth } = wx.getSystemInfoSync();\n      const { maxBarHeight, loadingBarHeight } = this.properties;\n\n      this.pixelRatio = 750 / screenWidth;\n\n      if (maxBarHeight) {\n        this.maxBarHeight = this.toRpx(maxBarHeight);\n      }\n\n      if (loadingBarHeight) {\n        this.setData({\n          computedLoadingBarHeight: this.toRpx(loadingBarHeight),\n        });\n        this.loadingBarHeight = this.toRpx(loadingBarHeight);\n      }\n    },\n\n    detached() {\n      clearTimeout(this.maxRefreshAnimateTimeFlag);\n      clearTimeout(this.closingAnimateTimeFlag);\n    },\n  };\n\n  observers = {\n    value(val) {\n      if (!val) {\n        clearTimeout(this.maxRefreshAnimateTimeFlag);\n        this.setData({ refreshStatus: 3 });\n        this.close();\n      }\n    },\n    maxBarHeight(val) {\n      this.maxBarHeight = this.toRpx(val);\n    },\n    loadingBarHeight(val) {\n      this.setData({\n        computedLoadingBarHeight: this.toRpx(val),\n      });\n      this.loadingBarHeight = this.toRpx(val);\n    },\n  };\n\n  methods = {\n    onScrollToBottom() {\n      this.triggerEvent('scrolltolower');\n    },\n    onScrollToTop() {\n      this.setData({\n        enableToRefresh: true,\n      });\n    },\n    onScroll(e) {\n      const { scrollTop } = e.detail;\n\n      this.setData({\n        enableToRefresh: scrollTop === 0,\n      });\n      this.triggerEvent('scroll', { scrollTop });\n    },\n    onTouchStart(e: WechatMiniprogram.Component.TrivialInstance) {\n      if (this.isPulling || !this.data.enableToRefresh) return;\n      const { touches } = e;\n      if (touches.length !== 1) return;\n      const { pageX, pageY } = touches[0];\n\n      this.setData({ loosing: false });\n      this.startPoint = { pageX, pageY };\n      this.isPulling = true;\n    },\n\n    onTouchMove(e: WechatMiniprogram.Component.TrivialInstance) {\n      if (!this.startPoint) return;\n\n      const { touches } = e;\n\n      if (touches.length !== 1) return;\n\n      const { pageY } = touches[0];\n      const offset = pageY - this.startPoint.pageY;\n      const barHeight = this.toRpx(offset);\n\n      if (barHeight > 0) {\n        if (barHeight > this.maxBarHeight) {\n          // 限高\n          this.setRefreshBarHeight(this.maxBarHeight);\n          // this.startPoint.pageY = pageY - this.toPx(this.maxBarHeight); // 限高的同时修正起点，避免触摸点上移时无效果\n        } else {\n          this.setRefreshBarHeight(barHeight);\n        }\n      }\n    },\n\n    onTouchEnd(e: WechatMiniprogram.Component.TrivialInstance) {\n      if (!this.startPoint) return;\n      const { changedTouches } = e;\n      if (changedTouches.length !== 1) return;\n      const { pageY } = changedTouches[0];\n\n      const barHeight = this.toRpx(pageY - this.startPoint.pageY);\n      this.startPoint = null; // 清掉起点，之后将忽略touchMove、touchEnd事件\n\n      this.setData({ loosing: true });\n\n      // 松开时高度超过阈值则触发刷新\n      if (barHeight > this.loadingBarHeight) {\n        this.setData({\n          barHeight: this.loadingBarHeight,\n          refreshStatus: 2,\n        });\n\n        this.triggerEvent('change', { value: true });\n        this.triggerEvent('refresh');\n        this.maxRefreshAnimateTimeFlag = setTimeout(() => {\n          this.maxRefreshAnimateTimeFlag = null;\n\n          if (this.data.refreshStatus === 2) {\n            // 超时回调\n            this.triggerEvent('timeout');\n            this.close(); // 超时仍未被回调，则直接结束下拉\n          }\n        }, this.properties.refreshTimeout as any) as any as number;\n      } else {\n        this.close();\n      }\n    },\n\n    toRpx(v: number | string): number {\n      if (typeof v === 'number') return v * this.pixelRatio;\n      return parseInt(v, 10);\n    },\n\n    toPx(v: number) {\n      return v / this.pixelRatio;\n    },\n\n    setRefreshBarHeight(barHeight: number) {\n      const data: Record<string, any> = { barHeight };\n      if (barHeight >= this.loadingBarHeight) {\n        data.refreshStatus = 1;\n      } else {\n        data.refreshStatus = 0;\n      }\n      return new Promise((resolve) => {\n        this.setData(data, () => resolve(barHeight));\n      });\n    },\n\n    close() {\n      const animationDuration = 240;\n\n      this.setData({ barHeight: 0 });\n      this.triggerEvent('change', { value: false });\n      this.closingAnimateTimeFlag = setTimeout(() => {\n        this.closingAnimateTimeFlag = null;\n        this.setData({ refreshStatus: -1 });\n        this.isPulling = false; // 退出下拉状态\n      }, animationDuration) as any as number;\n    },\n\n    setScrollTop(scrollTop: number) {\n      this.setData({ scrollTop });\n    },\n\n    scrollToTop() {\n      this.setScrollTop(0);\n    },\n  };\n}\n"]}