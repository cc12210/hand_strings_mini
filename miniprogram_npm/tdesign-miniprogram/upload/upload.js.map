{"version":3,"sources":["../../src/upload/upload.ts"],"names":[],"mappings":"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","file":"upload.js","sourcesContent":["import { isObject, SuperComponent, wxComponent } from '../common/src/index';\nimport props from './props';\nimport { UploadMpConfig, UploadFile } from './type';\nimport config from '../common/config';\n\nconst { prefix } = config;\nconst name = `${prefix}-upload`;\n@wxComponent()\nexport default class Upload extends SuperComponent {\n  externalClasses = [`${prefix}-class`];\n\n  options = {\n    multipleSlots: true,\n  };\n\n  data = {\n    classPrefix: name,\n    prefix,\n    current: false,\n    proofs: [],\n    customFiles: [] as UploadFile[], // 内部动态修改的files\n    customLimit: 0, // 内部动态修改的limit\n    // 以下是声明properties\n    config: {} as UploadMpConfig,\n    files: [] as UploadFile[],\n    max: 0,\n    sizeLimit: 0,\n    requestMethod: null,\n    gridItemStyle: '',\n    column: 4,\n  };\n\n  properties = props;\n\n  controlledProps = [\n    {\n      key: 'files',\n      event: 'success',\n    },\n  ];\n\n  observers = {\n    files(files: UploadFile) {\n      this.handleLimit(files, this.data.max);\n    },\n    max(max) {\n      this.handleLimit(this.data.customFiles, max);\n    },\n    gridConfig() {\n      this.updateGrid();\n    },\n  };\n\n  onProofTap(e: any) {\n    const { index } = e.currentTarget.dataset;\n    wx.previewImage({\n      urls: this.data.customFiles.filter((file) => file.percent !== -1).map((file) => file.url),\n      current: this.data.customFiles[index]?.url,\n    });\n  }\n\n  ready() {\n    this.handleLimit(this.data.customFiles, this.data.max);\n    this.updateGrid();\n  }\n\n  handleLimit(customFiles: UploadFile[], max: number) {\n    while (max !== 0 && customFiles.length - max > 0) {\n      customFiles.pop();\n    }\n    const proofs = [];\n    customFiles.forEach((item: UploadFile) => {\n      if (item.type !== 'video') {\n        proofs.push(item.url);\n      }\n    });\n    this.setData({\n      customFiles,\n      proofs,\n      customLimit: max === 0 ? Number.MAX_SAFE_INTEGER : max - customFiles.length,\n    });\n  }\n\n  uploadFiles(files: UploadFile[]) {\n    return new Promise((resolve) => {\n      // 开始调用上传函数\n      const task = this.data.requestMethod(files);\n      if (task instanceof Promise) {\n        return task;\n      }\n      resolve({});\n    });\n  }\n\n  startUpload(files: UploadFile[]) {\n    // 如果传入了上传函数，则进度设为0并开始上传，否则跳过上传\n    if (typeof this.data.requestMethod === 'function') {\n      return this.uploadFiles(files)\n        .then(() => {\n          files.forEach((file) => {\n            file.percent = 100;\n          });\n          this.triggerSuccessEvent(files);\n        })\n        .catch((err) => {\n          this.triggerFailEvent(err);\n        });\n    }\n\n    // 如果没有上传函数，success事件与微信api上传成功关联\n    this.triggerSuccessEvent(files);\n\n    this.handleLimit(this.data.customFiles, this.data.max);\n    return Promise.resolve();\n  }\n\n  triggerSuccessEvent(files) {\n    this._trigger('success', { files: [...this.data.customFiles, ...files] });\n  }\n\n  triggerFailEvent(err) {\n    this.triggerEvent('fail', err);\n  }\n\n  onFileClick(e) {\n    const { file } = e.currentTarget.dataset;\n    this.triggerEvent('click', { file });\n  }\n\n  /**\n   * 由于小程序暂时在ios上不支持返回上传文件的fileType，这里用文件的后缀来判断\n   * @param mediaType\n   * @param tempFilePath\n   * @returns string\n   * @link https://developers.weixin.qq.com/community/develop/doc/00042820b28ee8fb41fc4d0c254c00\n   */\n  getFileType(mediaType: string[], tempFilePath: string, fileType?: string) {\n    if (fileType) return fileType; // 如果有返回fileType就直接用\n    if (mediaType.length === 1) {\n      // 在单选媒体类型的时候直接使用单选媒体类型\n      return mediaType[0];\n    }\n    // 否则根据文件后缀进行判读\n    const videoType = ['avi', 'wmv', 'mkv', 'mp4', 'mov', 'rm', '3gp', 'flv', 'mpg', 'rmvb'];\n    const temp = tempFilePath.split('.');\n    const postfix = temp[temp.length - 1];\n    if (videoType.includes(postfix.toLocaleLowerCase())) {\n      return 'video';\n    }\n    return 'image';\n  }\n\n  // 选中文件之后，计算一个随机的短文件名\n  getRandFileName(filePath) {\n    const extIndex = filePath.lastIndexOf('.');\n    const extName = extIndex === -1 ? '' : filePath.substr(extIndex);\n    return parseInt(`${Date.now()}${Math.floor(Math.random() * 900 + 100)}`, 10).toString(36) + extName;\n  }\n\n  onDelete(e: any) {\n    const { index } = e.currentTarget.dataset;\n    this.deleteHandle(index);\n  }\n\n  deleteHandle(index: number) {\n    const { customFiles } = this.data;\n    const delFile = customFiles[index];\n    this.triggerEvent('remove', { index, file: delFile });\n  }\n\n  updateGrid() {\n    let { gridConfig = {} } = this.properties;\n    if (!isObject(gridConfig)) gridConfig = {};\n    const { column = 4, width = 160, height = 160 } = gridConfig as any;\n    this.setData({\n      gridItemStyle: `width:${width}rpx;height:${height}rpx`,\n      column: column,\n    });\n  }\n\n  methods = {\n    onAddTap() {\n      const { mediaType, source } = this.properties;\n\n      if (source === 'media') {\n        this.chooseMedia(mediaType);\n      } else {\n        this.chooseMessageFile(mediaType);\n      }\n    },\n\n    chooseMedia(mediaType) {\n      const { config, sizeLimit, max } = this.data;\n      wx.chooseMedia({\n        count: max === 0 ? 9 : max, // 在 iOS 里，0 是无效的，会导致抛异常\n        mediaType,\n        ...config,\n        success: (res) => {\n          const files = [];\n\n          // 支持单/多文件\n          res.tempFiles.forEach((temp) => {\n            const { size, fileType, tempFilePath, width, height, duration, thumbTempFilePath, ...res } = temp;\n            if (sizeLimit && size > sizeLimit) {\n              wx.showToast({ icon: 'none', title: `${fileType === 'image' ? '图片' : '视频'}大小超过限制` });\n              return;\n            }\n            const name = this.getRandFileName(tempFilePath);\n            files.push({\n              name,\n              type: this.getFileType(mediaType, tempFilePath, fileType),\n              url: tempFilePath,\n              size: size,\n              width: width,\n              height: height,\n              duration: duration,\n              thumb: thumbTempFilePath,\n              percent: 0,\n              ...res,\n            });\n          });\n          this.afterSelect(files);\n        },\n        fail: (err) => {\n          this.triggerFailEvent(err);\n        },\n        complete: (res) => {\n          this.triggerEvent('complete', res);\n        },\n      });\n    },\n\n    chooseMessageFile(mediaType) {\n      const { max, config, sizeLimit } = this.properties;\n      wx.chooseMessageFile({\n        count: max,\n        type: Array.isArray(mediaType) ? 'all' : mediaType,\n        ...config,\n        success: (res) => {\n          const files = [];\n\n          // 支持单/多文件\n          res.tempFiles.forEach((temp) => {\n            const { size, type: fileType, path: tempFilePath, ...res } = temp;\n            if (sizeLimit && size > sizeLimit) {\n              wx.showToast({ icon: 'none', title: `${fileType === 'image' ? '图片' : '视频'}大小超过限制` });\n              return;\n            }\n            const name = this.getRandFileName(tempFilePath);\n            files.push({\n              name,\n              type: this.getFileType(mediaType, tempFilePath, fileType),\n              url: tempFilePath,\n              size: size,\n              percent: 0,\n              ...res,\n            });\n          });\n          this.afterSelect(files);\n        },\n        fail: (err) => this.triggerFailEvent(err),\n        complete: (res) => this.triggerEvent('complete', res),\n      });\n    },\n\n    afterSelect(files) {\n      this._trigger('select-change', {\n        files: [...this.data.customFiles],\n        currentSelectedFiles: [files],\n      });\n      this._trigger('add', { files });\n      this.startUpload(files);\n    },\n  };\n}\n"]}