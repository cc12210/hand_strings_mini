{"version":3,"sources":["../../src/indexes/indexes.ts"],"names":[],"mappings":";;;;;;AAAA,OAAO,EAAoB,cAAc,EAAE,WAAW,EAAE,MAAM,qBAAqB,CAAC;AACpF,OAAO,MAAM,MAAM,kBAAkB,CAAC;AACtC,OAAO,KAAK,MAAM,SAAS,CAAC;AAC5B,OAAO,EAAE,OAAO,EAAE,QAAQ,EAAE,MAAM,iBAAiB,CAAC;AACpD,OAAO,eAAe,MAAM,uBAAuB,CAAC;AAEpD,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,CAAC;AAC1B,MAAM,IAAI,GAAG,GAAG,MAAM,UAAU,CAAC;AAGjC,IAAqB,OAAO,GAA5B,MAAqB,OAAQ,SAAQ,cAAc;IAAnD;;QACE,oBAAe,GAAG,CAAC,GAAG,MAAM,QAAQ,EAAE,GAAG,MAAM,gBAAgB,EAAE,GAAG,MAAM,qBAAqB,CAAC,CAAC;QAEjG,eAAU,GAAG,KAAK,CAAC;QAEnB,SAAI,GAAG;YACL,MAAM;YACN,WAAW,EAAE,IAAI;YACjB,OAAO,EAAE,CAAC;YACV,UAAU,EAAE,EAAE;YACd,SAAS,EAAE,CAAC;YACZ,YAAY,EAAE,IAAI;YAClB,QAAQ,EAAE,KAAK;SAChB,CAAC;QAEF,cAAS,GAAqB;YAC5B,kCAAkC,EAAE;gBAClC,IAAI,EAAE,OAAO;aACd;SACF,CAAC;QAEF,cAAS,GAAG;YACV,eAAe,CAAC,UAAU,KAAK;gBAC7B,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;YACvB,CAAC,CAAC;SACH,CAAC;QAEF,UAAK,GAAG,IAAI,CAAC;QAEb,aAAQ,GAAG,EAAE,CAAC;QAEd,YAAO,GAAG,IAAI,CAAC;QAEf,cAAS,GAAG;YACV,SAAS,CAAC,CAAC;gBACT,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;YACvB,CAAC;YACD,MAAM,CAAC,CAAC;gBACN,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;YACpB,CAAC;SACF,CAAC;QAEF,cAAS,GAAG;YACV,KAAK;;gBACH,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,KAAK,CAAC,EAAE;oBAC3B,IAAI,CAAC,SAAS,EAAE,CAAC;iBAClB;gBACD,IAAI,CAAA,MAAA,IAAI,CAAC,IAAI,CAAC,UAAU,0CAAE,MAAM,MAAK,CAAC,EAAE;oBACtC,IAAI,CAAC,YAAY,EAAE,CAAC;iBACrB;YACH,CAAC;SACF,CAAC;QAEF,YAAO,GAAG;YACR,SAAS,CAAC,MAAuB;gBAC/B,IAAI,CAAC,MAAM,EAAE;oBACX,MAAM,EAAE,YAAY,EAAE,GAAG,EAAE,CAAC,iBAAiB,EAAE,CAAC;oBAChD,MAAM,GAAG,YAAY,CAAC;iBACvB;gBACD,IAAI,CAAC,OAAO,CACV;oBACE,OAAO,EAAE,MAAM;iBAChB,EACD,GAAG,EAAE;oBACH,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC,CACF,CAAC;YACJ,CAAC;YAED,YAAY,CAAC,IAAI;gBACf,IAAI,CAAC,IAAI,EAAE;oBACT,MAAM,KAAK,GAAG,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;oBAChC,MAAM,QAAQ,GAAG,EAAE,CAAC;oBAEpB,KAAK,IAAI,CAAC,GAAG,KAAK,EAAE,GAAG,GAAG,KAAK,GAAG,EAAE,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,IAAI,CAAC,EAAE;wBACrD,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC;qBACvC;oBAED,IAAI,CAAC,OAAO,CAAC,EAAE,UAAU,EAAE,QAAQ,EAAE,CAAC,CAAC;iBACxC;qBAAM;oBACL,IAAI,CAAC,OAAO,CAAC,EAAE,UAAU,EAAE,IAAI,EAAE,CAAC,CAAC;iBACpC;YACH,CAAC;YAED,UAAU;gBACR,IAAI,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,GAAG,EAAE;oBAC9B,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE;wBACpC,MAAM,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;wBACtC,IAAI,CAAC,WAAW,GAAG,CAAC,CAAA,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,GAAG,KAAI,QAAQ,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC;oBACxD,CAAC,CAAC,CAAC;oBACH,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;gBAC5B,CAAC,CAAC,CAAC;gBACH,IAAI,CAAC,cAAc,EAAE,CAAC;YACxB,CAAC;YAED,cAAc;gBACZ,OAAO,OAAO,CAAC,GAAG,CAChB,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAC3B,OAAO,CAAC,KAAK,EAAE,IAAI,IAAI,SAAS,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE;oBAC9C,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;wBACjB,MAAM,EAAE,IAAI,CAAC,MAAM;wBACnB,GAAG,EAAE,IAAI,CAAC,GAAG;wBACb,MAAM,EAAE,KAAK,CAAC,IAAI,CAAC,KAAK;qBACzB,CAAC,CAAC;gBACL,CAAC,CAAC,CACH,CACF,CAAC;YACJ,CAAC;YAED,cAAc;gBACZ,OAAO,CAAC,IAAI,EAAE,OAAO,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE;oBAC9C,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC;oBAC7B,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC;oBAExC,IAAI,CAAC,OAAO,GAAG;wBACb,GAAG;wBACH,MAAM;wBACN,UAAU,EAAE,CAAC,MAAM,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,MAAM,EAAE,eAAe;qBAClE,CAAC;gBACJ,CAAC,CAAC,CAAC;YACL,CAAC;YAED,UAAU,CAAC,IAAa;gBACtB,IAAI,CAAC,IAAI,EAAE;oBACT,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBAC1B,IAAI,CAAC,KAAK,GAAG,UAAU,CAAC,GAAG,EAAE;wBAC3B,IAAI,CAAC,OAAO,CAAC;4BACX,QAAQ,EAAE,KAAK;yBAChB,CAAC,CAAC;oBACL,CAAC,EAAE,GAAG,CAAC,CAAC;iBACT;qBAAM;oBACL,IAAI,CAAC,OAAO,CAAC;wBACX,QAAQ,EAAE,IAAI;qBACf,CAAC,CAAC;iBACJ;YACH,CAAC;YAED,gBAAgB,CAAC,KAAK;gBACpB,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,IAAI,IAAI,CAAC,QAAQ,KAAK,KAAK;oBAAE,OAAO;gBAE7D,MAAM,EAAE,UAAU,EAAE,GAAG,IAAI,CAAC,IAAI,CAAC;gBACjC,MAAM,YAAY,GAAG,UAAU,CAAC,KAAK,CAAC,CAAC;gBACvC,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,KAAK,YAAY,CAAC,CAAC;gBAE1E,IAAI,MAAM,EAAE;oBACV,EAAE,CAAC,YAAY,CAAC;wBACd,SAAS,EAAE,MAAM,CAAC,GAAG;wBACrB,QAAQ,EAAE,CAAC;qBACZ,CAAC,CAAC;iBACJ;gBAED,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;gBACtB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;gBACtB,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;gBAErD,IAAI,YAAY,KAAK,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE;oBAC3C,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,YAAY,EAAE,CAAC,CAAC;iBACtD;YACH,CAAC;YAED,OAAO,CAAC,CAAC;gBACP,MAAM,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC,aAAa,CAAC,OAAO,CAAC;gBAE1C,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;YAC/B,CAAC;YAED,WAAW,CAAC,CAAC;gBACX,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC;YACxB,CAAC;YAED,aAAa;gBACX,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;YACzB,CAAC;YAED,UAAU,CAAC,CAAC;gBACV,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;gBACvB,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC;YACxB,CAAC;YAED,aAAa,EAAE,QAAQ,CAAC,UAAU,CAA+B;gBAC/D,MAAM,cAAc,GAAG,CAAC,OAAO,EAAE,EAAE;oBACjC,MAAM,OAAO,GAAG,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;oBAE3C,IAAI,OAAO,IAAI,CAAC,EAAE;wBAChB,OAAO,CAAC,CAAC;qBACV;oBAED,IAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;wBACjC,OAAO,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,MAAM,GAAG,CAAC,CAAC;qBACxC;oBAED,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;gBACvD,CAAC,CAAC;gBACF,MAAM,KAAK,GAAG,cAAc,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAE1D,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;YAC/B,CAAC,EAAE,IAAI,GAAG,EAAE,CAAC;YAEb,iBAAiB,CAAC,SAAiB;gBACjC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;oBAClB,OAAO;iBACR;gBAED,MAAM,EAAE,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,CAAC,IAAI,CAAC;gBAE3C,SAAS,IAAI,YAAY,CAAC;gBAE1B,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CACtC,CAAC,KAAK,EAAE,EAAE,CAAC,SAAS,IAAI,KAAK,CAAC,GAAG,GAAG,KAAK,CAAC,MAAM,IAAI,SAAS,IAAI,KAAK,CAAC,GAAG,GAAG,KAAK,CAAC,WAAW,GAAG,KAAK,CAAC,MAAM,CAC9G,CAAC;gBAEF,IAAI,QAAQ,KAAK,CAAC,CAAC;oBAAE,OAAO;gBAE5B,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;gBAEzC,IAAI,IAAI,CAAC,IAAI,CAAC,YAAY,KAAK,QAAQ,CAAC,MAAM,EAAE;oBAC9C,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,KAAK,EAAE,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC;iBACzD;gBAED,IAAI,CAAC,OAAO,CAAC;oBACX,YAAY,EAAE,QAAQ,CAAC,MAAM;iBAC9B,CAAC,CAAC;gBAEH,IAAI,MAAM,EAAE;oBACV,MAAM,MAAM,GAAG,QAAQ,CAAC,GAAG,GAAG,SAAS,CAAC;oBACxC,MAAM,OAAO,GAAG,MAAM,GAAG,QAAQ,CAAC,MAAM,IAAI,MAAM,GAAG,CAAC,IAAI,SAAS,GAAG,YAAY,CAAC;oBAEnF,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE;wBACtC,IAAI,KAAK,KAAK,QAAQ,EAAE;4BACtB,KAAK,CAAC,OAAO,CAAC;gCACZ,MAAM,EAAE,SAAS,GAAG,YAAY;gCAChC,MAAM,EAAE,IAAI;gCACZ,KAAK,EAAE,WAAW,QAAQ,CAAC,MAAM,IAAI;gCACrC,WAAW,EAAE,6BAA6B,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,gBAAgB,YAAY,IAAI;6BAC/F,CAAC,CAAC;yBACJ;6BAAM,IAAI,KAAK,GAAG,CAAC,KAAK,QAAQ,EAAE;4BACjC,sBAAsB;4BACtB,KAAK,CAAC,OAAO,CAAC;gCACZ,MAAM,EAAE,IAAI;gCACZ,MAAM,EAAE,IAAI;gCACZ,KAAK,EAAE,WAAW,QAAQ,CAAC,MAAM,IAAI;gCACrC,WAAW,EAAE,6BACX,OAAO,CAAC,CAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,CACvC,gBAAgB,YAAY,IAAI;6BACjC,CAAC,CAAC;yBACJ;6BAAM;4BACL,KAAK,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,EAAE,EAAE,CAAC,CAAC;yBAClE;oBACH,CAAC,CAAC,CAAC;iBACJ;YACH,CAAC;YAED,QAAQ,CAAC,EAAE,SAAS,EAAE;gBACpB,IAAI,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAC;YACpC,CAAC;SACF,CAAC;IACJ,CAAC;CAAA,CAAA;AAhQoB,OAAO;IAD3B,WAAW,EAAE;GACO,OAAO,CAgQ3B;eAhQoB,OAAO","file":"indexes.js","sourcesContent":["import { RelationsOptions, SuperComponent, wxComponent } from '../common/src/index';\nimport config from '../common/config';\nimport props from './props';\nimport { getRect, throttle } from '../common/utils';\nimport pageScrollMixin from '../mixins/page-scroll';\n\nconst { prefix } = config;\nconst name = `${prefix}-indexes`;\n\n@wxComponent()\nexport default class Indexes extends SuperComponent {\n  externalClasses = [`${prefix}-class`, `${prefix}-class-sidebar`, `${prefix}-class-sidebar-item`];\n\n  properties = props;\n\n  data = {\n    prefix,\n    classPrefix: name,\n    _height: 0,\n    _indexList: [],\n    scrollTop: 0,\n    activeAnchor: null,\n    showTips: false,\n  };\n\n  relations: RelationsOptions = {\n    '../indexes-anchor/indexes-anchor': {\n      type: 'child',\n    },\n  };\n\n  behaviors = [\n    pageScrollMixin(function (event) {\n      this.onScroll(event);\n    }),\n  ];\n\n  timer = null;\n\n  groupTop = [];\n\n  sidebar = null;\n\n  observers = {\n    indexList(v) {\n      this.setIndexList(v);\n    },\n    height(v) {\n      this.setHeight(v);\n    },\n  };\n\n  lifetimes = {\n    ready() {\n      if (this.data._height === 0) {\n        this.setHeight();\n      }\n      if (this.data._indexList?.length === 0) {\n        this.setIndexList();\n      }\n    },\n  };\n\n  methods = {\n    setHeight(height: string | number) {\n      if (!height) {\n        const { windowHeight } = wx.getSystemInfoSync();\n        height = windowHeight;\n      }\n      this.setData(\n        {\n          _height: height,\n        },\n        () => {\n          this.getAllRect();\n        },\n      );\n    },\n\n    setIndexList(list) {\n      if (!list) {\n        const start = 'A'.charCodeAt(0);\n        const alphabet = [];\n\n        for (let i = start, end = start + 26; i < end; i += 1) {\n          alphabet.push(String.fromCharCode(i));\n        }\n\n        this.setData({ _indexList: alphabet });\n      } else {\n        this.setData({ _indexList: list });\n      }\n    },\n\n    getAllRect() {\n      this.getAnchorsRect().then(() => {\n        this.groupTop.forEach((item, index) => {\n          const next = this.groupTop[index + 1];\n          item.totalHeight = (next?.top || Infinity) - item.top;\n        });\n        this.setAnchorOnScroll(0);\n      });\n      this.getSidebarRect();\n    },\n\n    getAnchorsRect() {\n      return Promise.all(\n        this.$children.map((child) =>\n          getRect(child, `.${name}-anchor`).then((rect) => {\n            this.groupTop.push({\n              height: rect.height,\n              top: rect.top,\n              anchor: child.data.index,\n            });\n          }),\n        ),\n      );\n    },\n\n    getSidebarRect() {\n      getRect(this, `#id-${name}__bar`).then((rect) => {\n        const { top, height } = rect;\n        const { length } = this.data._indexList;\n\n        this.sidebar = {\n          top,\n          height,\n          itemHeight: (height - (length - 1) * 2) / length, // margin = 2px\n        };\n      });\n    },\n\n    toggleTips(flag: boolean) {\n      if (!flag) {\n        clearInterval(this.timer);\n        this.timer = setTimeout(() => {\n          this.setData({\n            showTips: false,\n          });\n        }, 300);\n      } else {\n        this.setData({\n          showTips: true,\n        });\n      }\n    },\n\n    setAnchorByIndex(index) {\n      if (this.preIndex != null && this.preIndex === index) return;\n\n      const { _indexList } = this.data;\n      const activeAnchor = _indexList[index];\n      const target = this.groupTop.find((item) => item.anchor === activeAnchor);\n\n      if (target) {\n        wx.pageScrollTo({\n          scrollTop: target.top,\n          duration: 0,\n        });\n      }\n\n      this.preIndex = index;\n      this.toggleTips(true);\n      this.triggerEvent('select', { index: activeAnchor });\n\n      if (activeAnchor !== this.data.activeAnchor) {\n        this.triggerEvent('change', { index: activeAnchor });\n      }\n    },\n\n    onClick(e) {\n      const { index } = e.currentTarget.dataset;\n\n      this.setAnchorByIndex(index);\n    },\n\n    onTouchMove(e) {\n      this.onAnchorTouch(e);\n    },\n\n    onTouchCancel() {\n      this.toggleTips(false);\n    },\n\n    onTouchEnd(e) {\n      this.toggleTips(false);\n      this.onAnchorTouch(e);\n    },\n\n    onAnchorTouch: throttle(function (e: WechatMiniprogram.TouchEvent) {\n      const getAnchorIndex = (clientY) => {\n        const offsetY = clientY - this.sidebar.top;\n\n        if (offsetY <= 0) {\n          return 0;\n        }\n\n        if (offsetY > this.sidebar.height) {\n          return this.data._indexList.length - 1;\n        }\n\n        return Math.floor(offsetY / this.sidebar.itemHeight);\n      };\n      const index = getAnchorIndex(e.changedTouches[0].clientY);\n\n      this.setAnchorByIndex(index);\n    }, 1000 / 30), // 30 frame\n\n    setAnchorOnScroll(scrollTop: number) {\n      if (!this.groupTop) {\n        return;\n      }\n\n      const { sticky, stickyOffset } = this.data;\n\n      scrollTop += stickyOffset;\n\n      const curIndex = this.groupTop.findIndex(\n        (group) => scrollTop >= group.top - group.height && scrollTop <= group.top + group.totalHeight - group.height,\n      );\n\n      if (curIndex === -1) return;\n\n      const curGroup = this.groupTop[curIndex];\n\n      if (this.data.activeAnchor !== curGroup.anchor) {\n        this.triggerEvent('change', { index: curGroup.anchor });\n      }\n\n      this.setData({\n        activeAnchor: curGroup.anchor,\n      });\n\n      if (sticky) {\n        const offset = curGroup.top - scrollTop;\n        const betwixt = offset < curGroup.height && offset > 0 && scrollTop > stickyOffset;\n\n        this.$children.forEach((child, index) => {\n          if (index === curIndex) {\n            child.setData({\n              sticky: scrollTop > stickyOffset,\n              active: true,\n              style: `height: ${curGroup.height}px`,\n              anchorStyle: `transform: translate3d(0, ${betwixt ? offset : 0}px, 0); top: ${stickyOffset}px`,\n            });\n          } else if (index + 1 === curIndex) {\n            // 两个 anchor 同时出现时的上一个\n            child.setData({\n              sticky: true,\n              active: true,\n              style: `height: ${curGroup.height}px`,\n              anchorStyle: `transform: translate3d(0, ${\n                betwixt ? offset - curGroup.height : 0\n              }px, 0); top: ${stickyOffset}px`,\n            });\n          } else {\n            child.setData({ active: false, sticky: false, anchorStyle: '' });\n          }\n        });\n      }\n    },\n\n    onScroll({ scrollTop }) {\n      this.setAnchorOnScroll(scrollTop);\n    },\n  };\n}\n"]}