{"version":3,"sources":["../../src/common/src/instantiationDecorator.ts"],"names":[],"mappings":"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","file":"instantiationDecorator.js","sourcesContent":["import { isPlainObject, toObject } from './flatTool';\nimport { SuperComponent } from './superComponent';\nimport { canUseVirtualHost } from '../version';\n\n// 将 on 开头的生命周期函数转变成非 on 开头的\nconst RawLifeCycles = ['Created', 'Attached', 'Ready', 'Moved', 'Detached', 'Error'];\nconst NativeLifeCycles = RawLifeCycles.map((k) => k.toLowerCase());\n\nconst ComponentNativeProps = [\n  'properties',\n  'data',\n  'observers',\n  'methods',\n  'behaviors',\n  // life times properties\n  ...NativeLifeCycles,\n  'relations',\n  'externalClasses',\n  'options',\n  'lifetimes',\n  'pageLifeTimes',\n  'definitionFilter',\n];\n\n/**\n * 将一个普通的 options 对象转化处理为 Component 支持的对象\n * 在这里需要对一些方法进行操作\n * @param options {}\n */\nexport const toComponent = function toComponent(options: Record<string, any>) {\n  const { relations, behaviors = [], properties } = options;\n\n  if (options.properties) {\n    Object.keys(options.properties).forEach((k) => {\n      let opt = options.properties[k];\n      // 如何不是 Object 类型，则默认指定 type = options.properties[k]；\n      if (!isPlainObject(opt)) {\n        opt = { type: opt };\n      }\n      options.properties[k] = opt;\n    });\n\n    // 内置 aria 相关属性\n    const ariaProps = [\n      { key: 'ariaHidden', type: Boolean },\n      { key: 'ariaRole', type: String },\n      { key: 'ariaLabel', type: String },\n      { key: 'ariaLabelledby', type: String },\n      { key: 'ariaDescribedby', type: String },\n      { key: 'ariaBusy', type: Boolean },\n    ];\n    ariaProps.forEach(({ key, type }) => {\n      options.properties[key] = {\n        type,\n      };\n    });\n\n    // 处理 style 和 customStyle 属性\n    options.properties.style = { type: String, value: '' };\n    options.properties.customStyle = { type: String, value: '' };\n  }\n\n  if (!options.methods) options.methods = {};\n\n  if (!options.lifetimes) options.lifetimes = {};\n\n  const inits: { [key: string]: PropertyDescriptor } = {};\n\n  if (relations) {\n    const getRelations = (relation, path) =>\n      Behavior({\n        created() {\n          Object.defineProperty(this, `$${relation}`, {\n            get: () => {\n              const nodes = this.getRelationNodes(path) || [];\n              return relation === 'parent' ? nodes[0] : nodes;\n            },\n          });\n        },\n      });\n    const map = {};\n\n    Object.keys(relations).forEach((path) => {\n      const comp = relations[path];\n      const relation = ['parent', 'ancestor'].includes(comp.type) ? 'parent' : 'children';\n      const mixin = getRelations(relation, path);\n      map[relation] = mixin;\n    });\n\n    behaviors.push(...Object.keys(map).map((key) => map[key]));\n  }\n\n  options.behaviors = [...behaviors];\n\n  Object.getOwnPropertyNames(options).forEach((k) => {\n    const desc = Object.getOwnPropertyDescriptor(options, k);\n    if (!desc) return;\n    if (NativeLifeCycles.indexOf(k) < 0 && typeof desc.value === 'function') {\n      // 非生命周期函数挂载到 methods 对象上面\n      Object.defineProperty(options.methods, k, desc);\n      delete options[k];\n    } else if (ComponentNativeProps.indexOf(k) < 0) {\n      // 非函数，也非组件内部属性\n      // 由于小程序组件会忽略不能识别的字段，需要这里需要把这些字段配置在组件 created 的时候赋值\n      inits[k] = desc;\n    } else if (NativeLifeCycles.indexOf(k) >= 0) {\n      options.lifetimes[k] = options[k];\n    }\n  });\n\n  if (Object.keys(inits).length) {\n    const oldCreated = options.lifetimes.created;\n    const oldAttached = options.lifetimes.attached;\n    const { controlledProps = [] } = options;\n\n    options.lifetimes.created = function (...args) {\n      Object.defineProperties(this, inits);\n      if (oldCreated) oldCreated.apply(this, args);\n    };\n\n    options.lifetimes.attached = function (...args) {\n      if (oldAttached) oldAttached.apply(this, args);\n\n      controlledProps.forEach(({ key }) => {\n        const defaultKey = `default${key.replace(/^(\\w)/, (m, m1) => m1.toUpperCase())}`;\n        const props = this.properties;\n\n        if (props[key] == null) {\n          this._selfControlled = true;\n        }\n\n        if (props[key] == null && props[defaultKey] != null) {\n          this.setData({\n            [key]: props[defaultKey],\n          });\n        }\n      });\n    };\n\n    options.methods._trigger = function (evtName, detail, opts) {\n      const target = controlledProps.find((item) => item.event == evtName);\n      if (target) {\n        const { key } = target;\n\n        if (this._selfControlled) {\n          this.setData({\n            [key]: detail[key],\n          });\n        }\n      }\n      this.triggerEvent(evtName, detail, opts);\n    };\n  }\n\n  return options;\n};\n\n/**\n * 将一个继承了 BaseComponent 的类转化成 小程序 Component 的调用\n * 根据最新的微信 d.ts 描述文件，Component 在实例化的时候，会忽略不支持的自定义属性\n */\nexport const wxComponent = function wxComponent() {\n  return function (constructor: new () => SuperComponent): void {\n    class WxComponent extends constructor {\n      // 暂时移除了冗余的代码，后续补充\n    }\n\n    const current = new WxComponent();\n\n    // 所有组件默认都开启css作用域\n    // 写到这里是为了防止组件设置 options 时无意覆盖掉了 addGlobalClass\n    current.options = current.options || {};\n    if (current.options.addGlobalClass === undefined) {\n      current.options.addGlobalClass = true;\n    }\n\n    if (canUseVirtualHost()) {\n      current.options.virtualHost = true;\n    }\n\n    const obj = toComponent(toObject(current));\n    Component(obj);\n  };\n};\n"]}